# 数据库

## 1.基本概念

数据库管理系统是位于用户与操作系统之间的一层数据管理软件，其基本目标是提供一个可以方便、有效地存储数据库信息的环境


### 1.1 基本组成

数据库系统DBS是一个采用了数据库技术，有组织、动态地存储大量相关数据，方便多用户访问的计算机系统。广义上讲，DBS是数据库、硬件、软件和人员组成的。


- 数据库DB：数据库是统一管理的、长期储存在计算机内的、有组织的相关数据的集合。其特点是数据间联系密切、冗余度小、独立性高、易扩展，并且可为各类用户共享

- 硬件
- 软件：包括操作系统、数据库管理系统以及应用程序。数据库管理系统是数据库系统的核心软件，需要在操作系统的支持下工作，解决如何科学地组织和存储数据，如何高效地获取和维护数据。其主要功能包括数据定义功能、数据操纵功能、数据库的运行管理和数据库的建立和维护

- 人员，包括
    - 系统分析员和数据库设计人员：应用系统的需求分析和规范说明，输出数据库系统的概要设计
    - 应用程序员：负责编写使用数据库的应用程序，这些应用程序可以对数据库进行检索、建立、删除或者修改
    - 最终用户：使用应用系统的接口或者利用查询语言访问数据库
    - 数据库管理员：负责数据库的总体信息控制


### 1.2 数据库管理系统的功能

- 数据定义：DBMS提供DDL数据定义语言，对数据库的结构进行描述，数据库的完整性定义，安全保密定义。这些定义存储在数据字典中，是DBMS运行的基本依据
- 数据库操作：DBMS提供DML数据操纵语言，实现对数据库中数据的基本操作，如检索、插入、修改和删除
- 数据库运行管理：运行期间多用户环境下的并发控制、安全性检查...
- 数据的组织、存储和管理
- 数据库的建立和维护
- 其它功能：比如网络通信功能，两个不同数据库之间的数据互访和操作能力

### 1.3 数据库管理系统的特征以及分类

#### 1.3.1 特征
- 数据结构化且统一管理
- 与较高的数据独立性
- 数据控制功能
    - 数据库的安全性
    - 数据的完整性
    - 并发控制
    - 故障恢复

#### 1.3.2 分类
DBMS通常可以分为以下三类：
- 关系数据库系统RDBS：基于关系
- 面向对象的数据库系统OODBS：基于面向对象，具有封装和继承性
- 对象关系数据库系统ORDBS：在传统的关系数据模型上提供元组、数据、集合等更为丰富的数据类型以及处理新的数据类型操作的能力

### 1.4 体系结构
- 集中式：数据和数据的管理都集中在DBMS所在计算机上

- 并行式：多个物理上连接在一起的CPU，分为共享式内存多处理器+无共享式并行体系结构

![并行数据库系统.png](https://wbccb.github.io/Frontend-Articles/image/并行数据库系统.png)

- C/S（客户端/服务器）：一个处理机的请求（客户端）可以发送到另外一个处理机（服务端）进行处理
    - 数据库系统功能分为前端和后端，前端主要包括图形界面、表格生成和报表处理等工具
    - 后端负责存储数据、查询计算和优化、并发控制以及故障恢复等
    - 主要分为事务服务器和数据服务器，事务服务器也称为查询服务器，提供一个接口给客户端发送执行一个工作的请求到服务器执行；数据服务器可以让客户端和服务器进行交互，以文件或者页面为单位对数据进行读取或者更新

- 分布式：分布式系统是多个地理上分开的CPU，分为 `物理上分布、逻辑上集中` + `物理上分布、逻辑上分布`两种

数据库系统体系结构一般采用三级模式结构

### 1.5 三级模式结构


![数据库三级模式结构.png](https://wbccb.github.io/Frontend-Articles/image/数据库三级模式结构.png)

概念模式：数据库中全部数据的逻辑结构和特征的描述，只涉及到型的描述，不涉及具体的值，反映的是数据库的结构及其练习，所示是相对稳定的
> 实例反映的是数据库某一时刻的状态，所示是相对变动的


外模式：用户模式或者子模式，是用户与数据库系统的接口，是用户用到的那部分数据的描述
> 用户使用数据操纵语言对数据库进行操作，实际是对外模式的外部记录进行操作

内模式：也称为存储模式，是数据物理结构和存储方式的描述，是数据在数据库内部的表达方式的，定义所有的内部记录类型、索引和文件的组织方式，以及数据控制方面的细节，例如记录的存储方式是顺序存储/按照B树结构存储/按照Hash方法存储；数据是否压缩加密等

两级映像：分为`模式/内模式`、`外模式/模式映像`
- `模式/内模式`：存在于概念级和内部级之间，实现概念模式和内模式之间的相互转换
- `外模式/模式映像`：存在于外部级和概念机之间，实现概念模式和外模式之间的相互转换


数据的独立是指数据和程序独立，将数据的定义从程序中分离出去。
数据的独立是由DBMS的二级映像功能来保证的，数据的独立性包括
- 物理独立性：数据库内模式发生改变时(存储数据的格式、顺序等等)，数据的逻辑结构不变。由于应用程序处理的只是数据的逻辑结构，因此物理独立性可以保证：当数据的物理结构发生改变时，应用程序不用改变
> 当然为了保证应用程序能够正确执行，需要修改概念模式和内模式之间的映像

- 数据的逻辑独立性：指用户的应用程序与数据库的逻辑结构是相互独立的，当数据的逻辑结构发生变化时，用户程序也可以不用修改
> 当然为了保证应用程序能够正确执行，需要修改概念模式和外模式之间的映像



### 1.6 大数据

大数据是指`无法用现有的软件工具提取、存储、搜索、共享、分析和处理的海量的、复杂的数据集合`

#### 产生背景
- 数据来源和承载方式的变革
- 全球数据量出现爆炸式增长
- 大数据已经成为一种自然资源
- 大数据日益重要，不被利用就是成本

#### 特征
- 大量化：数据体量巨大
- 多样化：数据类型繁多
- 价值密度低
- 快速化：对时效性要求很高，在大数据环境下数据流通常为高速实时数据流，而且需要快速、持续的实时处理；处理工具也在快速演进


#### 大数据还有待加强的地方

大数据不仅仅是指海量的信息，更强调人类对信息的筛选、处理，保留有价值的信息，即让大数据更有意义，挖掘其潜在的大价值。

需要解决的问题有：
- 高并发数据存取的性能要求及数据存储的横向扩展问题
- 实现大数据资源化、知识化、普适化的问题
- 非结构化海量数据信息的智能化处理


面临的挑战：
- 软件和数据处理能力
- 资源和共享管理
- 数据处理的可信力



#### 大数据产生的安全风险

- 大数据成为网络攻击的显著目标
- 大数据加大了隐私泄漏风险
- 大数据威胁现有的存储和安防措施
- 大数据成为黑客的攻击手段
- 大数据成为高级可持续攻击的载体
- 大数据技术为信息安全提供新支撑

## 2.数据模型

数据库的基础是数据模型，是用来描述数组的一组概念和定义。数据模型的三要素是：
- 数据结构：所研究对象类型的集合，是对系统静态特征的描述
- 数据操作
- 数据的约束条件：一组完整性规则的集合，对于具体的应用程序必须遵循特定的语义约束条件，以保证数据的正确、有效和相容

### 2.1 基本概念

概念数据模型：信息模型，是按照用户的观点对数据和信息建模
基本数据模型：按照计算机系统的观点对数据建模，是现实世界数据特征的抽象，用于DBMS的实现。

> 基本数据模型有：层次模型、网状模型、关系模型、面向对象模型

### 2.2 E-R模型(概念数据模型)

概念模型有很多种表示方法，其中最常用的就是`E-R模型`，称为实体-联系模型


> `E-R模型`只能说明实体间的语义联系，还不能进一步地详细说明数据结构。在解决实际应用问题时，通常先设计一个`E-R模型`，然后再把其转换为计算机能够接受的数据模型


![ER特殊化应用实例.png](https://wbccb.github.io/Frontend-Articles/image/ER特殊化应用实例.png)


### 2.3 关系模型（基本数据模型）

基本数据模型：
- 层次模型
- 网状模型
- 关系模型
- 面向对象模型

最常用的就是关系模型

![关系模型的实例.png](https://wbccb.github.io/Frontend-Articles/image/关系模型的实例.png)




## 3.关系代数

5种基本的关系代数运算：
- 并
- 差
- 笛卡尔积
- 投影
- 选择

![关系代数运算.png](https://wbccb.github.io/Frontend-Articles/image/关系代数运算.png)


![自然连接.png](https://wbccb.github.io/Frontend-Articles/image/自然连接.png)



## 4. SQL

作为关系数据库标准语言

### 4.1 特点

- 综合统一
- 高度非过程化
- 面向集合的操作方式
- 两种使用方式：使用终端键盘上输入SQL命令 或者 SQL语言嵌入到高级语言程序中
- 语言简洁、易学易用：SQL语言功能极强，完成核心功能只用了9个动词，包括以下4类：
    - 数据查询：SELECT
    - 数据定义：CREATE、DROP、ALTER
    - 数据操纵：INSERT、UPDATE、DELETE
    - 数据控制：GRANT、REVORK

### 4.2 三级模式结构

SQL语言支持关系数据库的三级模式结构

- 视图对应外模式
- 基本表对应模式
- 存储文件对应内模式

### 4.3 各种操作集合


## ？？5.关系数据库的规范化


### ？？5.1 函数依赖

关系数据库设计理论的核心是数据间的函数依赖，衡量的标准是关系规范化的程度以及分解的无损连接和保持函数依赖性。

关系数据库设计的目标是生成一组合适的、性能良好的关系模式，以减少系统中信息存储的冗余度，并可方便地获取信息


### 5.2 规范化

通过分解，可以将低一级范式的关系模式转换成为若干个高一级范式的关系模式，这个过程称为规范化

#### 1NF第一范式

定义：若关系模式R的每一个分量是不可再分的数据项，则关系模式R属于第一范式。

![第一范式.png](https://wbccb.github.io/Frontend-Articles/image/第一范式.png)

存在的问题：
- 冗余度大
- 引入修改操作的不一致性
- 插入异常
- 删除异常：供应商S4的P2零件销售完了，以后也不销售P2，应该删除S4这一行，但是基本关系就找不到S4了，但是S4是真实存在的
> 解决方法就是把一些容易变化的拆出来形成新的表，这就是下面第二范式要说的内容

#### 2NF第二范式

![第一范式.png](https://wbccb.github.io/Frontend-Articles/image/第一范式.png)
将上面的表格拆为：
1. first1(Sno, Sname, Status, City)
2. first2(Sno, Pno, Qty)

**定义**：当关系模式属于第一范式时，并且每一个非主属性完全依赖于码，则关系模式属于第二范式

#### 3NF第三范式

**定义**：当2NF消除了非属性对码的传递函数依赖，则称为3NF
> 例如，first1存在 `Sno->Status`、`Status->City`，存在非属性City传递依赖于码Sno，因此first1不属于3NF

如果将first1继续分解，first1(Sno, Sname, Status, City)：
- first11(Sno, Sname, Status)
- first12(Status, City)
则first11和first12都满足第三范式



#### 关系模式的规范化处理

将1NF第一范式 -> 2NF第二范式 -> 3NF第三范式的过程


### ??5.3 模式分解以及分解应该有的特性




## 6.数据库的控制功能

### 6.1 事务管理

事务是一个操作序列，这些操作“要么都做，要么都不做”，是数据库环境中不可分割的逻辑工作单位。

事务和程序是两个不同的概念，一般一个程序可包含多个失误。在SQL语言中，事务定义的语句有以下三条：

- 事务开始
- 事务提交
- 事务回滚

事务具有`原子性`、`一致性`、`隔离性`和`持久性`，简称为ACID性质

### 6.2 数据库的备份与恢复

#### 故障类型
- 事务内部故障：比如运算溢出、并发事务发生死锁
- 系统故障：CPU故障、操作系统故障、突然停电
- 介质故障：硬故障，如磁盘损坏、磁头碰撞等等
- 计算机病毒

#### 备份方法

**备份**
- 静态转储和动态转储
- 海量转储和增量转储
- 日志文件


**恢复**
- 反向扫描文件日志（从最后向前扫描日志文件），查找该事务的更新操作
- 对事务的更新操作执行逆操作
- 继续反向扫描日志文件，查找该事务的其它更新操作，并做同样的处理，直到事务的开始标志

#### 数据库镜像
避免磁盘介质出现故障影响数据库的可用性，许多DBMS提供数据库镜像功能用于数据库恢复

### 6.3 并发控制

带来的问题：
- 丢失修改：并发写数据，有的程序value=value+1，有的value=value+2，导致数据被覆盖
- 不可重复读：事务A读+事务B写，然后事务A执行了上次的读操作，两次操作读取的值不一样，导致运算不一样，事务B干扰了事务A
- 读脏数据：有一些数据读取后，然后又会滚了，导致其他程序读取的是旧数据

#### 并发控制的技术

主要的技术是封锁：
- 排他锁：也叫X锁或者写锁，事务T为数据加上`排他锁`，其它事务无法加上其它锁，不能操作数据
- 共享锁：也叫S锁或者读锁，事务T为数据加上`共享锁`，只能读取数据，不能修改，其它事务也可以加上`共享锁`，但是不能加`排他锁`

------
三级封锁协议：

一级封锁协议：解决丢失更新问题，修改数据时必须加上X锁
二级封锁协议：解决脏数据问题，读取数据时必须加上S锁，读完释放。不能解决重复读问题
三级封锁协议：一级封锁的基础上，读取数据前必须加上S锁，防止读取数据时，其它事务修改数据，有效解决`不可重复读`问题

-----

活锁：事务A一直无法拿到资源处理的问题，因为一直有其它事务占据资源
死锁：一个资源被两个事务占据，完全卡住的问题

-----
多个事务的并发执行是正确的，串行执行的结果也相同，这种调度策略是可串化的调度
> 可能只是某一个并发与串行执行的结果相同


---- 
事务的加锁和解锁是分开的，不能同时加锁和解锁

----
封锁对象的粒度可以是逻辑单元（如属性、元组、关系、索引项、整个索引甚至整个数据库），也可以是物理单元（如数据页或者索引页）




